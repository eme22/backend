import{Bc as l,Fc as p,Ic as f,N as t,Q as g,U as a,f as i,j as c,ra as h}from"./chunk-HE7H4WY4.js";var m=class s{constructor(e,r){this.http=e;this.platformId=r;if(this.isBrowser()){let n=localStorage.getItem("access_token"),S=localStorage.getItem("refresh_token"),u=localStorage.getItem("user");if(n&&u)try{let o=JSON.parse(u);this.currentUserSubject.next(o)}catch(o){console.warn("Error parsing stored user data:",o),this.clearStorageData()}}}apiUrl=f.apiUrl;currentUserSubject=new c(null);currentUser$=this.currentUserSubject.asObservable();isBrowser(){return l(this.platformId)}getFromStorage(e){return this.isBrowser()?localStorage.getItem(e):null}setInStorage(e,r){this.isBrowser()&&localStorage.setItem(e,r)}removeFromStorage(e){this.isBrowser()&&localStorage.removeItem(e)}clearStorageData(){this.removeFromStorage("access_token"),this.removeFromStorage("refresh_token"),this.removeFromStorage("user"),this.currentUserSubject.next(null)}getUserId(){let e=this.getFromStorage("user");if(e)try{return JSON.parse(e).id}catch(r){console.error("Error parsing user data:",r)}}login(e){return this.http.post(`${this.apiUrl}/auth/login`,e).pipe(t(r=>{this.setInStorage("access_token",r.access_token),this.setInStorage("refresh_token",r.refresh_token),this.setInStorage("user",JSON.stringify(r.user)),this.currentUserSubject.next(r.user)}))}register(e){return this.http.post(`${this.apiUrl}/auth/register`,e)}refreshToken(){let e=this.getFromStorage("refresh_token");if(!e)throw new Error("No refresh token available");return this.http.post(`${this.apiUrl}/auth/refresh`,{refresh_token:e}).pipe(t(r=>{this.setInStorage("access_token",r.access_token),this.setInStorage("refresh_token",r.refresh_token),this.setInStorage("user",JSON.stringify(r.user)),this.currentUserSubject.next(r.user)}))}getProfile(){return this.http.get(`${this.apiUrl}/auth/profile`)}refreshProfile(){return this.getProfile().pipe(t(e=>{this.setInStorage("user",JSON.stringify(e)),this.currentUserSubject.next(e)}))}logout(){let e=this.getFromStorage("refresh_token");return this.clearStorageData(),e?this.http.post(`${this.apiUrl}/auth/logout`,{refresh_token:e}):new i(r=>{r.next(),r.complete()})}isAuthenticated(){return!!this.getFromStorage("access_token")&&!!this.currentUserSubject.value}getCurrentUser(){let e=this.currentUserSubject.value;if(e)return e;let r=this.getFromStorage("user");return r?JSON.parse(r):null}getToken(){return this.getFromStorage("access_token")}getRefreshToken(){return this.getFromStorage("refresh_token")}decodeToken(e){try{let r=e.split(".")[1];return JSON.parse(atob(r))}catch{return null}}isTokenExpiring(){let e=this.getToken();if(!e)return!1;let r=this.decodeToken(e);if(!r||!r.exp)return!1;let n=Date.now()/1e3;return r.exp-n<300}refreshTokenIfNeeded(){return this.isTokenExpiring()?this.refreshToken():new i(e=>{e.next(null),e.complete()})}static \u0275fac=function(r){return new(r||s)(a(p),a(h))};static \u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})};export{m as a};
